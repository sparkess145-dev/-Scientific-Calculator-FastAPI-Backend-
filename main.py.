from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
# Import standard SymPy functions for math operations
from sympy import integrate, diff, solve, simplify, parse_expr

# Initialize FastAPI application
app = FastAPI()

# CORS configuration to allow connections from your frontend
# You must replace the origins list with your FINAL FlutterFlow domain once known
origins = [
    "https://flutter-flow--sparkess145.replit.app", # Old Replit placeholder
    "*", # Temporary: Allows all origins for testing Render deployment
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/")
def read_root():
    return {"message": "Scientific Calculator Backend is running (Permanent Deployment)."}

@app.post("/calculate")
def calculate_expression(expression: str, operation: str = None, variable: str = 'x'):
    """
    Handles mathematical operations (Calculation, Integration, Differentiation, Solving).
    """
    try:
        # Safely parse the input string into a SymPy expression
        parsed_expression = parse_expr(expression)
        
        # 1. Solving 
        if operation == "solve":
            # Solves the expression equal to zero for the specified variable
            result = solve(parsed_expression, variable)
        
        # 2. Integration
        elif operation == "integral":
            result = integrate(parsed_expression, variable)
            
        # 3. Differentiation
        elif operation == "derivative":
            result = diff(parsed_expression, variable)
            
        # 4. Standard Calculation / Simplification (Default operation)
        else:
            result = simplify(parsed_expression)

        # Return the result as a string
        return {"result": str(result)}

    except Exception as e:
        # Return a generic error message
        return {"result": f"Error: {e}"}

# End of main.py
